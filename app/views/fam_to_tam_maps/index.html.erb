<% content_for :head do %>
  <%= javascript_include_tag 'jstree-read-only/jquery.jstree.js' %>
<% end %>

<script type="text/javascript">
$(function () {
	$("#lba_tree")
		.bind("check_node.jstree", function (e, data) {
			switch(data.rslt.obj.attr("rel")) {
				case "lbo":
					break;
				case "lba":
					break;
				case "build_feature":
					$.ajax({
					  type: 'POST',
  					url: "<%= fam_to_tam_maps_path %>",
  					context: $(this),
						data: { "fam_to_tam_map": {"build_feature_id" : data.rslt.obj.attr("id"), "feature_id" : <%= @feature.id %> }},
						success: function (r) {
						  // Add it to the right side
						  $('#right_side ul').append(r);
						  $('#right_side li:last').effect("highlight", {}, 3000);
						},
						dataType: "html"
					});
					break;
			};
		})
		.bind("uncheck_node.jstree", function (e, data) {
			switch(data.rslt.obj.attr("rel")) {
				case "lbo":
					break;
				case "lba":
					break;
				case "build_feature":
					$.ajax({
						async : false,
						type: 'DELETE',
						url: "<%= fam_to_tam_maps_path %>/-1",
						data: { "build_feature_id" : data.rslt.obj.attr("id"), "feature_id" : <%= @feature.id %> },
						success : function (r) {
						  // Remove it to from right side
//						  $('#right_side ul li[id=' + r.bam_to_fam_feature.id + ']').fadeOut(200, function(){$(this).remove()});
						  $('#right_side ul li[id=' + r.fam_to_tam_map.id + ']').remove();
						},
						dataType: "json"
					});
					break;
			};
		})
		.jstree({
			"core" : {"animation" : 100,
								"initially_open" : ["root"] },
			"types" : {
				"max_depth" : -2,
				"max_children" : -2,
				"types" : {
					"build_feature" : {
						"valid_children" : ["build_feature"],
						"icon" : {
							"image" : "./icons/bullet_black.png"
						}
					}
				}
			},
	    "html_data" : { data : "<li id='root' rel='root' class='jstree-closed'><a href='#'>Logical Business Areas</a></li>",
											state: "closed",
	  	  							ajax : {
	  		  							url: "/lbas/lba_children.html",
	  			  						data : function (n) {
						  								   return { id : n.attr ? n.attr("id") : 0, rel: n.attr ? n.attr("rel") : "" };
							  							 }
	  						  		}
  	  },
  	"ui" : {"select_limit" : 1},
			"types" : {
				"types" : {
					"root" : {
						"icon" : {
							"image" : "/icons/application_cascade.png"
						}
					},
					"lba" : {
						"icon" : {
							"image" : "/icons/package.png"
						}
					},
					"lbo" : {
						"icon" : {
							"image" : "/icons/brick.png"
						}
					},
					"build_feature" : {
						"icon" : {
							"image" : "/icons/bullet_black.png"
						}
					}
				}
			},
		"plugins" : [ "themes", "html_data", "types", "ui", "checkbox" ]
	});
});
</script>

<% title "Logical Business Areas" %>

<div class="push-1 span-22 last">
  <div class="span-10 colborder">
	  <div class="span-10">
			<button class="button" id="open_all">Open All</button>
			<button class="button" id="close_all">Close All</button>
			<button class="button" id="open_current">Open Selected</button>
			<button class="button" id="close_current">Close Selected</button>
		</div>

	  <div class="span-10">
			<div id="lba_tree" style="overflow: auto;"></div>
		</div>

	</div>

  <div class="span-11 last">
    <div class="span-8 last">
    	<h4>Mapped Technical Features</h4>
    	<div id="right_side" class="span-8 last">
    	  <ul>
    	    <% for fam_to_tam_map in @fam_to_tam_maps %>
    	      <%= render :partial => "mapped_feature", :locals => { :mapped_feature => fam_to_tam_map } %>
    	    <% end %>
    	  </ul>
    	</div>
    </div>
	</div>

	</div>
</div>

<script type="text/javascript">
$(function () {
	$("#open_all").click(function () {
	  $("#lba_tree").jstree("open_all");
  });
	$("#remove, #rename").click(function () {
    $("#lba_tree").jstree(this.id);
  });
	$("#close_all").click(function () {
	  $("#lba_tree").jstree("close_all");
  });
	$("#open_current").click(function (e,data) {
	  $("#lba_tree").jstree("open_all", ".jstree-clicked");
  });
	$("#close_current").click(function (e,data) {
	  $("#lba_tree").jstree("close_all", ".jstree-clicked");
  });
});
</script>





<% if false %>
<% title "Fam To Tam Maps" %>

<table>
  <tr>
    <th>Feature</th>
    <th>Build Feature</th>
    <th>Iteration</th>
  </tr>
  <% for fam_to_tam_map in @fam_to_tam_maps %>
    <tr>
      <td><%=h fam_to_tam_map.feature_id %></td>
      <td><%=h fam_to_tam_map.build_feature_id %></td>
      <td><%=h fam_to_tam_map.iteration_id %></td>
      <td><%= link_to "Show", fam_to_tam_map %></td>
      <td><%= link_to "Edit", edit_fam_to_tam_map_path(fam_to_tam_map) %></td>
      <td><%= link_to "Destroy", fam_to_tam_map, :confirm => 'Are you sure?', :method => :delete %></td>
    </tr>
  <% end %>
</table>

<p><%= link_to "New Fam To Tam Map", new_fam_to_tam_map_path %></p>
<% end %>
